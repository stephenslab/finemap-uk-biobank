---
title: "UKBiobank Blood Cell"
author: "Yuxin Zou"
date: "10/26/2020"
output: 
  workflowr::wflow_html:
    code_folding: hide
---

The UkB blood cell traits are

PheID | Abbrev    | Phenotype                                  | Cell type          | Determination
------|-----------|--------------------------------------------|--------------------|--------------
30000 | WBCcount  | White blood cell count                     | Compound white cell| Measured
30010 | RBCcount  | Red blood cell count                       | Mature red cell    | Measured
30020 | HGB       | Haemoglobin concentration                  | Mature red cell    | Measured
30030 | HCT       | Haematocrit percentage                     | Mature red cell    | (RBCcount x MCV) / 10
30040 | MCV       | Mean corpuscular volume                    | Mature red cell    | Measured
30050 | MCH       | Mean corpuscular haemoglobin               | Mature red cell    | (hemoglobin/RBCcount) x 10
30060 | MCHC      | Mean corpuscular haemoglobin concentration | Mature red cell    | (haemoglobin/haematocrit) x 100
30070 | RDW       | Red blood cell distribution width          | Mature red cell    | Measured
30080 | PLTcount  | Platelet count                             | Platelet           | Measured
30090 | PCT       | Platelet crit                              | Platelet           | Measured
30100 | MPV       | Mean platelet (thrombocyte) volume         | Platelet           | (PCT/PLTcount) x 10000
30110 | PDW       | Platelet distribution width                | Platelet           | Measured
30120 | LYMPHcount| Lymphocyte count                           | Lymphoid white cell| (LYMPHperc/100) x WBCcount
30130 | MONOcount | Monocyte count                             | Myeloid white cell | (MONOperc/100) x WBCcount
30140 | NEUTcount | Neutrophill count                          | Myeloid white cell | (NEUTperc/100) x WBCcount
30150 | EOcount   | Eosinophill count                          | Myeloid white cell | (EOperc/100) x WBCcount
30160 | BASOcount | Basophill count                            | Myeloid white cell | (BASOperc/100) x WBCcount
30180 | LYMPHperc | Lymphocyte percentage                      | Compound white cell| Measured
30190 | MONOperc  | Monocyte percentage                        | Compound white cell| Measured
30200 | NEUTperc  | Neutrophill percentage                     | Compound white cell| Measured
30210 | EOperc    | Eosinophill percentage                     | Compound white cell| Measured
30220 | BASOperc  | Basophill percentage                       | Compound white cell| Measured
30240 | RETperc   | Reticulocyte percentage                    | Immature red cell  | Measured
30250 | RETcount  | Reticulocyte count                         | Immature red cell  | (RETperc/100) × RBCcount
30260 | MRV       | Mean reticulocyte volume                   | Immature red cell  | MCV x (RETperc/100)
30270 | MSCV      | Mean sphered cell volume                   | Mature red cell    | Measured
30280 | IRF       | Immature reticulocyte fraction             | Immature red cell  | HLRcount/RETcount
30290 | HLRperc   | High light scatter reticulocyte percentage | Immature red cell  | Measured
30300 | HLRcount  | High light scatter reticulocyte count      | Immature red cell  | (HLRperc/100) × RBCcount

To prepare the phenotype data, we need to remove samples with abnormal observations. Since we will jointly model blood cell traits using multivariate normal distribution, we want to discard outliers in multivariate normal, instead of univariate normal. There are derived phenotypes which depend on several measured phenotype. To simplify the problem, we discard directly derived phenotypes. **We use 16 phenotypes.**

```{r}
trait_names = c("WBC_count", "RBC_count", "Haemoglobin", "MCV", "RDW", "Platelet_count", "Plateletcrit", "PDW", "Lymphocyte_perc", "Monocyte_perc", "Neutrophill_perc", "Eosinophill_perc", "Basophill_perc", "Reticulocyte_perc", "MSCV", "HLR_perc")
```

We filtered individuals with following criteria:

1. Remove samples that are not marked as being "White British".

2. Remove samples with missing values.

3. Remove samples with mismatches between self-reported and genetic sex.

4. Remove outliers defined by UK Biobank.

5. Remove any individuals have at leat one relative based on the kinship calculations.

6. Remove any pregnant individuals.

7. Remove any individuals with following in hospital in-patient data:
    
    leukemia, lymphoma, bone marrow transplant, chemotherapy, myelodysplastic syndrome, anemia, HIV, end-stage kidney disease, dialysis, cirrhosis, multiple myeloma, lymphocytic leukemia, myeloid leukemia, polycythaemia vera, haemochromatosis

8. Identify outliers in multivariate normal.


Load UKBiobank Blood Cell traits (individuals are filtered using [script](../scripts/get_bloodcells.R) before line 121).
```{r, message=FALSE}
library(data.table)
library(dplyr)
dat = fread('data/bloodcells1.csv')
class(dat) <- "data.frame"
```
There are `r nrow(dat)` individuals.

Check distribution for each trait:
```{r}
par(mfrow=c(2,3))
hist(dat$WBC_count[dat$WBC_count < 20], breaks = 100, main=paste0('WBC_count ', sum(dat$WBC_count > 20), ' inds > 20'), xlab='x')
hist(dat$RBC_count, main='RBC_count', xlab='x', breaks = 100)
hist(dat$Haemoglobin, main='Haemoglobin', xlab='x', breaks = 100)
hist(dat$MCV, main='MCV', xlab='x', breaks = 100)
hist(dat$RDW[dat$RDW < 20], main=paste0('RDW ', sum(dat$RDW > 20), ' inds > 20'), xlab='x', breaks = 100)
hist(dat$Platelet_count, main='Platelet_count', xlab='x', breaks = 100)
hist(dat$Plateletcrit, main='Plateletcrit', xlab='x', breaks = 100)
hist(dat$PDW, main='PDW', xlab='x', breaks = 50)
hist(dat$Lymphocyte_perc, main='Lymphocyte_perc', xlab='x', breaks = 100)
hist(dat$Monocyte_perc[dat$Monocyte_perc < 20], main=paste0('Monocyte_perc ', sum(dat$Monocyte_perc > 20), ' inds > 20'), xlab='x', breaks = 100)
hist(dat$Neutrophill_perc, main='Neutrophill_perc', xlab='x', breaks = 100)
hist(dat$Eosinophill_perc[dat$Eosinophill_perc < 10], main=paste0('Eosinophill_perc ', sum(dat$Eosinophill_perc > 10), ' inds > 10'), xlab='x', breaks = 100)
hist(dat$Basophill_perc[dat$Basophill_perc < 4], main=paste0('Basophill_perc ', sum(dat$Basophill_perc > 4), ' inds > 4'), xlab='x', breaks = 50)
hist(dat$Reticulocyte_perc[dat$Reticulocyte_perc < 4], main=paste0('Reticulocyte_perc ', sum(dat$Reticulocyte_perc > 4), ' inds > 4'), xlab='x', breaks = 50)
hist(dat$MSCV, main='MSCV', xlab='x', breaks = 100)
hist(dat$HLR_perc[dat$HLR_perc < 2], main=paste0('HLR_perc ', sum(dat$HLR_perc > 2), ' inds > 2'), xlab='x', breaks = 50)
```

Inverse normalization for each trait:
```{r}
dat_1 = dat
for(i in 16:31){
  dat_1[,i] = qnorm((rank(dat_1[,i],na.last="keep")-0.5)/sum(!is.na(dat_1[,i])))
}
```

```{r}
par(mfrow=c(2,3))
for(i in 16:31){
  hist(dat_1[,i], breaks = 50, main=colnames(dat_1)[i], xlab='x')
}
```

## Identify Outliers

```{r}
trait_names = c("WBC_count", "RBC_count", "Haemoglobin", "MCV", "RDW", "Platelet_count", "Plateletcrit", "PDW", "Lymphocyte_perc", "Monocyte_perc", "Neutrophill_perc", "Eosinophill_perc", "Basophill_perc", "Reticulocyte_perc", "MSCV", "HLR_perc")
dat_1_traits = dat_1 %>% select(all_of(trait_names))
```

Covariace matrix of traits
```{r}
library(corrplot)
covy = cov(dat_1_traits)
corrplot(covy, method='color', type='upper', tl.col="black", tl.srt=45, is.corr = FALSE)
```

Measure Mahalanobis distance
```{r}
D2 = stats::mahalanobis(dat_1_traits, center=0, cov=covy) # squared Mahalanobis distance
{hist(D2[D2 < 60], breaks = 100, main=paste0('Mahalanobis distance: ', sum(D2 > 60), ' inds D2 > 60'),  xlab='D2')
abline(v=qchisq(0.01, df=16, lower.tail = F))}
```

The Mahalanobis distance follows a Chi-Square distribution with df = 16. We compute the 99.9%-Quantile of the Chi-Square
distribution with 16 degrees of freedomm and we remove samples with Mahalanobis distance greater than the distance.
```{r}
dat_select = dat_1[D2 < qchisq(0.01, df=16, lower.tail = F),]
```

There are `r nrow(dat_select)` individuals.


