---
title: "UKBiobank Blood Cell"
author: "Yuxin Zou"
date: "10/26/2020"
output: 
  workflowr::wflow_html:
    code_folding: hide
---

The UkB blood cell traits are
```{r}
library(kableExtra)
library(knitr)
PheID = seq(30000, 30300, by=10)
PheID = PheID[-which(PheID %in% c(30170,30230))]
Abbrev = c('WBCcount', 'RBCcount', 'HGB', 'HCT', 'MCV', 'MCH', 'MCHC', 'RDW', 'PLTcount', 'PCT', 'MPV', 'PDW', 'LYMPHcount', 'MONOcount', 'NEUTcount', 'EOcount', 'BASOcount', 'LYMPHperc', 'MONOperc', 'NEUTperc', 'EOperc', 'BASOperc', 'RETperc', 'RETcount', 'MRV', 'MSCV', 'IRF', 'HLRperc', 'HLRcount')
Phenotype = c('White blood cell count', 'Red blood cell count', 'Haemoglobin concentration', 'Haematocrit percentage', 'Mean corpuscular volume', 'Mean corpuscular haemoglobin', 'Mean corpuscular haemoglobin concentration', 'Red blood cell distribution width', 'Platelet count', 'Platelet crit', 'Mean platelet (thrombocyte) volume', 'Platelet distribution width', 'Lymphocyte count', 'Monocyte count', 'Neutrophill count', 'Eosinophill count', 'Basophill count', 'Lymphocyte percentage', 'Monocyte percentage', 'Neutrophill percentage', 'Eosinophill percentage', 'Basophill percentage', 'Reticulocyte percentage', 'Reticulocyte count', 'Mean reticulocyte volume', 'Mean sphered cell volume', 'Immature reticulocyte fraction', 'High light scatter reticulocyte percentage', 'High light scatter reticulocyte count')
Cell_Type = c('Compound white cell', 'Mature red cell', 'Mature red cell', 'Mature red cell', 'Mature red cell', 'Mature red cell', 'Mature red cell', 'Mature red cell', 'Platelet', 'Platelet', 'Platelet', 'Platelet', 'Lymphoid white cell', 'Myeloid white cell', 'Myeloid white cell', 'Myeloid white cell', 'Myeloid white cell', 'Compound white cell', 'Compound white cell', 'Compound white cell', 'Compound white cell', 'Compound white cell', 'Immature red cell', 'Immature red cell', 'Immature red cell', 'Mature red cell', 'Immature red cell', 'Immature red cell', 'Immature red cell')
Determination = c('Measured', 'Measured', 'Measured', '(RBCcount x MCV) / 10', 'Measured', '(hemoglobin/RBCcount) x 10', '(haemoglobin/haematocrit) x 100', 'Measured', 'Measured', 'Measured', '(PCT/PLTcount) x 10000', 'Measured', '(LYMPHperc/100) x WBCcount', '(MONOperc/100) x WBCcount', '(NEUTperc/100) x WBCcount', '(EOperc/100) x WBCcount', '(BASOperc/100) x WBCcount', 'Measured', 'Measured', 'Measured', 'Measured', 'Measured', 'Measured', '(RETperc/100) × RBCcount', 'MCV x (RETperc/100)', 'Measured', 'HLRcount/RETcount', 'Measured', '(HLRperc/100) × RBCcount')

Phenos = data.frame(PheID, Abbrev, Phenotype, Cell_Type, Determination)
kbl(Phenos) %>% kable_paper("striped", full_width = F) %>% row_spec(which(Phenos$Determination == 'Measured'), background = "greenyellow")
```

To prepare the phenotype data, we need to remove samples with abnormal observations. Since we will jointly model blood cell traits using multivariate normal distribution, we want to discard outliers in multivariate normal, instead of univariate normal. There are derived phenotypes which depend on several measured phenotype. To simplify the problem, we discard directly derived phenotypes. **We use 16 phenotypes.**

```{r}
trait_names = c("WBC_count", "RBC_count", "Haemoglobin", "MCV", "RDW", "Platelet_count", "Plateletcrit", "PDW", "Lymphocyte_perc", "Monocyte_perc", "Neutrophill_perc", "Eosinophill_perc", "Basophill_perc", "Reticulocyte_perc", "MSCV", "HLR_perc")
```

We filtered individuals with following criteria:

1. Remove samples that are not marked as being "White British".

2. Remove samples with missing values.

3. Remove samples with mismatches between self-reported and genetic sex.

4. Remove outliers defined by UK Biobank.

5. Remove any individuals have at leat one relative based on the kinship calculations.

6. Remove any pregnant individuals.

7. Remove any individuals with following in hospital in-patient data:
    
    leukemia, lymphoma, bone marrow transplant, chemotherapy, myelodysplastic syndrome, anemia, HIV, end-stage kidney disease, dialysis, cirrhosis, multiple myeloma, lymphocytic leukemia, myeloid leukemia, polycythaemia vera, haemochromatosis

8. Identify outliers in multivariate normal.


Load UKBiobank Blood Cell traits (individuals are filtered using [script](https://github.com/stephenslab/finemap-uk-biobank/blob/master/scripts/get_bloodcells.R) before line 121).
```{r, message=FALSE}
library(data.table)
library(dplyr)
dat = fread('data/bloodcells1.csv')
class(dat) <- "data.frame"
```
There are `r nrow(dat)` individuals.

Check distribution for each trait:
```{r}
par(mfrow=c(2,3))
hist(dat$WBC_count[dat$WBC_count < 20], breaks = 100, main=paste0('WBC_count ', sum(dat$WBC_count > 20), ' inds > 20'), xlab='x')
hist(dat$RBC_count, main='RBC_count', xlab='x', breaks = 100)
hist(dat$Haemoglobin, main='Haemoglobin', xlab='x', breaks = 100)
hist(dat$MCV, main='MCV', xlab='x', breaks = 100)
hist(dat$RDW[dat$RDW < 20], main=paste0('RDW ', sum(dat$RDW > 20), ' inds > 20'), xlab='x', breaks = 100)
hist(dat$Platelet_count, main='Platelet_count', xlab='x', breaks = 100)
hist(dat$Plateletcrit, main='Plateletcrit', xlab='x', breaks = 100)
hist(dat$PDW, main='PDW', xlab='x', breaks = 50)
hist(dat$Lymphocyte_perc, main='Lymphocyte_perc', xlab='x', breaks = 100)
hist(dat$Monocyte_perc[dat$Monocyte_perc < 20], main=paste0('Monocyte_perc ', sum(dat$Monocyte_perc > 20), ' inds > 20'), xlab='x', breaks = 100)
hist(dat$Neutrophill_perc, main='Neutrophill_perc', xlab='x', breaks = 100)
hist(dat$Eosinophill_perc[dat$Eosinophill_perc < 10], main=paste0('Eosinophill_perc ', sum(dat$Eosinophill_perc > 10), ' inds > 10'), xlab='x', breaks = 100)
hist(dat$Basophill_perc[dat$Basophill_perc < 4], main=paste0('Basophill_perc ', sum(dat$Basophill_perc > 4), ' inds > 4'), xlab='x', breaks = 50)
hist(dat$Reticulocyte_perc[dat$Reticulocyte_perc < 4], main=paste0('Reticulocyte_perc ', sum(dat$Reticulocyte_perc > 4), ' inds > 4'), xlab='x', breaks = 50)
hist(dat$MSCV, main='MSCV', xlab='x', breaks = 100)
hist(dat$HLR_perc[dat$HLR_perc < 2], main=paste0('HLR_perc ', sum(dat$HLR_perc > 2), ' inds > 2'), xlab='x', breaks = 50)
```

Inverse normalization for each trait:
```{r}
dat_1 = dat
for(i in 16:31){
  dat_1[,i] = qnorm((rank(dat_1[,i],na.last="keep")-0.5)/sum(!is.na(dat_1[,i])))
}
```

```{r}
par(mfrow=c(2,3))
for(i in 16:31){
  hist(dat_1[,i], breaks = 50, main=colnames(dat_1)[i], xlab='x')
}
```

## Identify Outliers

```{r}
trait_names = c("WBC_count", "RBC_count", "Haemoglobin", "MCV", "RDW", "Platelet_count", "Plateletcrit", "PDW", "Lymphocyte_perc", "Monocyte_perc", "Neutrophill_perc", "Eosinophill_perc", "Basophill_perc", "Reticulocyte_perc", "MSCV", "HLR_perc")
dat_1_traits = dat_1 %>% select(all_of(trait_names))
```

Covariace matrix of traits
```{r}
library(corrplot)
covy = cov(dat_1_traits)
corrplot(covy, method='color', type='upper', tl.col="black", tl.srt=45, is.corr = FALSE)
```

Measure Mahalanobis distance
```{r}
D2 = stats::mahalanobis(dat_1_traits, center=0, cov=covy) # squared Mahalanobis distance
{hist(D2[D2 < 60], breaks = 100, main=paste0('Mahalanobis distance: ', sum(D2 > 60), ' inds D2 > 60'),  xlab='D2')
abline(v=qchisq(0.01, df=16, lower.tail = F))}
```

The Mahalanobis distance follows a Chi-Square distribution with df = 16. We compute the 99.9%-Quantile of the Chi-Square
distribution with 16 degrees of freedomm and we remove samples with Mahalanobis distance greater than the distance.
```{r}
dat_select = dat_1[D2 < qchisq(0.01, df=16, lower.tail = F),]
```

There are `r nrow(dat_select)` individuals.


