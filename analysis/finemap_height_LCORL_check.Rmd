---
title: "Fine-mapping Height LCORL -- SuSiE check"
author: "Yuxin Zou"
date: "10/07/2019"
output: 
  html_document:
    code_folding: hide
---

We perform some check for the SuSiE result on region around LCORL.

Load pacakges:
```{r message=FALSE}
library(readr)
library(dplyr)
library(gridExtra)
library(susieR)
```
Load plotting functions:
```{r}
knitr::read_chunk("../scripts/plots.R")
```

```{r plots}
```

```{r}
locus.zoom.cs = function(z, cs, pos, gene.pos.map=NULL, z.ref.name=NULL, ld=NULL, title = NULL, title.size = 10, xrange = NULL, y.lab=NULL){
  if(is.null(y.lab)){
    y.lab = '-log10(p value)'
  }
  tmp = data.frame(POS = pos, log10p = -(pnorm(-abs(z), log.p = T) + log(2))/log(10))
  tmp$ref = names(z) == z.ref.name
  tmp$r2 = ld^2
  tmp$CS = rep(4, length(z))
  tmp$CS[cs] = 16
  tmp$CS = as.factor(tmp$CS)
  pl_zoom = ggplot(tmp, aes(x = POS, y = log10p, shape = CS, color = r2, size=CS)) + 
    geom_point() + ylab(y.lab) + 
    scale_colour_discrete_gradient(
        colours = c("darkblue", "deepskyblue", "lightgreen", "orange", "red"),
        limits = c(0, 1.01),
        breaks = c(0,0.2,0.4,0.6,0.8,1),
        guide = guide_colourbar(nbin = 100, raster = FALSE, frame.colour = "black", ticks.colour = NA)) +
    scale_shape_manual(values = c(4, 16), guide=FALSE) + 
    scale_size_manual(values=c(1.5,4), guide=FALSE) + 
    ggtitle(title) + 
    theme_bw() + theme(axis.title.x=element_blank(), plot.title = element_text(size=title.size))
  tmp.sub = tmp[cs,]
  pl_zoom = pl_zoom + geom_point(data = tmp.sub, aes(x=POS, y=log10p), shape=1, size=4, color='black', stroke=0.1)
  if(!is.null(xrange)){
    pl_zoom = pl_zoom + xlim(xrange[1], xrange[2])
  }
  
  pl_gene = plot_geneName(gene.pos.map, xrange = xrange)
  g = egg::ggarrange(pl_zoom, pl_gene, nrow=2, heights = c(5,1.5), draw=FALSE)
  g
}
```

Get summary statistics:
```{r}
ss.dat = readRDS('../data/height.LCORL.0.01.XtX.Xty.rds')
betas = as.vector(ss.dat$Xty)/diag(ss.dat$XtX)
rss = c(ss.dat$yty) - betas * ss.dat$Xty
se = as.vector(sqrt(rss/((ss.dat$n-1)*diag(ss.dat$XtX))))
z = betas/se
pval = 2*pnorm(-abs(z))
R = as.matrix(t(ss.dat$XtX * (1/sqrt(diag(ss.dat$XtX)))) * (1/ sqrt(diag(ss.dat$XtX))))
names(z) = rownames(R)
```

Get gene data:
```{r warning=FALSE, message=FALSE}
genes        <- read_delim("../data/seq_gene.md.gz",delim = "\t",quote = "")
class(genes) <- "data.frame"
genes        <- subset(genes,
                       group_label == "GRCh37.p5-Primary Assembly" &
                       feature_type == "GENE")
start.pos <- min(ss.dat$pos$POS)
stop.pos  <- max(ss.dat$pos$POS)
plot.genes <- subset(genes,
                     chromosome == 4 &
                     ((chr_start > start.pos & chr_start < stop.pos) |
                      (chr_stop > start.pos & chr_start < stop.pos)) & feature_type == 'GENE')
gene.pos.map = plot.genes %>% select(feature_name, chr_start, chr_stop)
colnames(gene.pos.map) = c('geneName', 'start', 'end')
gene.pos.map = as.data.frame(gene.pos.map)
gene.pos.map = gene.pos.map %>% mutate(start = start/1e6, end = end/1e6)
gene.pos.map = gene.pos.map[-c(3, 10),]
```

SuSiE result:
```{r fig.align='center', fig.width=30, fig.height=15}
mod_bhat.ld = susie_bhat(bhat = betas, shat = se, R = R, n = ss.dat$n, var_y = as.numeric(ss.dat$yty/(ss.dat$n-1)))
z.max = which.max(abs(z))
pip_bhat = susie_plot_locuszoom(z, mod_bhat.ld, pos = ss.dat$pos$POS/1e6, gene.pos.map = gene.pos.map, ld = R[z.max,], z.ref.name = names(z.max), title = 'LCORL SuSiE bhat')
p_bhat = susie_plot_locuszoom(z, mod_bhat.ld, pos = ss.dat$pos$POS/1e6, gene.pos.map = gene.pos.map, ld = R[z.max,], z.ref.name = names(z.max), title = 'LCORL SuSiE bhat', y.susie = 'p')
grid.arrange(pip_bhat, p_bhat, ncol=2)
```

For 1Mb region about LCORL, SuSiE found 2 CSs. The average correlation between SNPs in CS1 and CS2 is
```{r}
round(mean(abs(R[mod_bhat.ld$sets$cs$L1, mod_bhat.ld$sets$cs$L2])), 4)
```

## Removing effect of CS1

CS1:

```{r warning=FALSE}
z.max = which.max(abs(z))
locus.zoom.cs(z, cs = mod_bhat.ld$sets$cs$L1, ss.dat$pos$POS/1e6, gene.pos.map = gene.pos.map, ld = R[z.max,], z.ref.name = names(z.max), xrange=c(17.7,18.1), title = 'LCORL CS1')
```

```{r eval=FALSE}
library(data.table)
library(readr)
library(Matrix)
geno.file = 'height.LCORL.0.01.raw.gz'
cat("Reading genotype data.\n")
geno <- fread(geno.file,sep = "\t",header = TRUE,stringsAsFactors = FALSE)
class(geno) <- "data.frame"

# Extract the genotypes.
X <- as(as.matrix(geno[-(1:6)]),'dgCMatrix')

pheno.file <- "/gpfs/data/stephens-lab/finemap-uk-biobank/data/raw/height.csv.gz"
out.pheno.file <- "pheno.height.txt"
out.covar.file <- "covar.removeCS1.height.txt"

# LOAD PHENOTYPE and COVARIATES DATA
# -------------------
# Read the phenotype data from the CSV file.
cat("Reading phenotype data.\n")
pheno        <- suppressMessages(read_csv(pheno.file))
class(pheno) <- "data.frame"
pheno$sex = factor(pheno$sex)
pheno$assessment_centre = factor(pheno$assessment_centre)
pheno$genotype_measurement_batch = factor(pheno$genotype_measurement_batch)
pheno$age2 = pheno$age^2
# match individual order with genotype file
ind = fread('height.LCORL.0.01.psam')
match.idx = match(ind$IID, pheno$id)
pheno = pheno[match.idx,]

Z = model.matrix(~ sex + age + age2 + assessment_centre + genotype_measurement_batch +
                   pc_genetic1 + pc_genetic2 + pc_genetic3 + pc_genetic4 + pc_genetic5 +
                   pc_genetic6 + pc_genetic7 + pc_genetic8 + pc_genetic9 + pc_genetic10 +
                   pc_genetic11 + pc_genetic12 + pc_genetic13 + pc_genetic14 + pc_genetic15 +
                   pc_genetic16 + pc_genetic17 + pc_genetic18 + pc_genetic19 + pc_genetic20 + X[,1351], data = pheno)

# Remove intercept
Z = Z[,-1]
colnames(Z)[150] = 'X1351'
# standardize quantitative columns
cols = which(colnames(Z) %in% c("age","pc_genetic1","pc_genetic2","pc_genetic3","pc_genetic4",
                                "pc_genetic5","pc_genetic6","pc_genetic7","pc_genetic8","pc_genetic9", 
                                "pc_genetic10","pc_genetic11","pc_genetic12","pc_genetic13","pc_genetic14",
                                "pc_genetic15","pc_genetic16","pc_genetic17","pc_genetic18","pc_genetic19","pc_genetic20", "X1351"))
Z[,cols] = scale(Z[,cols])
Z[,'age2'] = Z[,'age']^2
# Save phenotype file
pheno.table = data.frame(FID = pheno$id, IID = pheno$id, height = pheno$height)
write.table(pheno.table, file = out.pheno.file, quote = FALSE, row.names = FALSE)
# Save covariates file
IID = pheno$id
FID = pheno$id
cov.table = cbind(FID, IID, Z)
write.table(cov.table, file= out.covar.file, quote=FALSE, row.names = FALSE)
```

```
plink2 --linear hide-covar no-x-sex omit-ref --pfile height.LCORL.0.01 --covar covar.removeCS1.height.txt --pheno pheno.height.txt --vif 100 --out height.LCORL.0.01.removeCS1.plink2
```

```{r warning=FALSE}
lm.res = read.delim('../data/height.LCORL.0.01.removeCS1.plink2.height.glm.linear')
lm.res.t = lm.res$T_STAT
names(lm.res.t) = lm.res$ID
z.max = which.max(abs(lm.res.t))
locus.zoom.cs(lm.res.t, cs = mod_bhat.ld$sets$cs$L2, pos=lm.res$POS/1e6, gene.pos.map = gene.pos.map, z.ref.name = lm.res$ID[z.max], ld = R[z.max,], xrange=c(17.7, 18.1), title='LCORL CS2', y.lab = '-log10(p value condition on CS1)')
```

## Simulation under the estimated model

In the following simulation, we treat rs6824748 and rs2610989 as true signals. The effect sizes are simulated using the estiamted prior variance. We use the fitted residual variance in the simulation. The response y is simulated from
$$
y \sim N_n(Xb, \sigma^2 I)
$$
, where X the genotype matrix that column centered, scaled, and removed the effect of covariates.

```{r eval=FALSE}
# ON CRI
library(data.table)
library(readr)
library(Matrix)
library(susieR)
geno.file = 'height.LCORL.0.01.raw.gz'
cat("Reading genotype data.\n")
geno <- fread(geno.file,sep = "\t",header = TRUE,stringsAsFactors = FALSE)
class(geno) <- "data.frame"

# Extract the genotypes.
X <- as(as.matrix(geno[-(1:6)]),'dgCMatrix')

pheno.file <- "/gpfs/data/stephens-lab/finemap-uk-biobank/data/raw/height.csv.gz"

# LOAD PHENOTYPE and COVARIATES DATA
# -------------------
# Read the phenotype data from the CSV file.
cat("Reading phenotype data.\n")
pheno        <- suppressMessages(read_csv(pheno.file))
class(pheno) <- "data.frame"
pheno$sex = factor(pheno$sex)
pheno$assessment_centre = factor(pheno$assessment_centre)
pheno$genotype_measurement_batch = factor(pheno$genotype_measurement_batch)
pheno$age2 = pheno$age^2
# match individual order with genotype file
ind = fread('height.LCORL.0.01.psam')
match.idx = match(ind$IID, pheno$id)
pheno = pheno[match.idx,]

Z = model.matrix(~ sex + age + age2 + assessment_centre + genotype_measurement_batch +
                   pc_genetic1 + pc_genetic2 + pc_genetic3 + pc_genetic4 + pc_genetic5 +
                   pc_genetic6 + pc_genetic7 + pc_genetic8 + pc_genetic9 + pc_genetic10 +
                   pc_genetic11 + pc_genetic12 + pc_genetic13 + pc_genetic14 + pc_genetic15 +
                   pc_genetic16 + pc_genetic17 + pc_genetic18 + pc_genetic19 + pc_genetic20, data = pheno)

# Remove intercept
Z = Z[,-1]
# standardize quantitative columns
cols = which(colnames(Z) %in% c("age","pc_genetic1","pc_genetic2","pc_genetic3","pc_genetic4",
                                "pc_genetic5","pc_genetic6","pc_genetic7","pc_genetic8","pc_genetic9", 
                                "pc_genetic10","pc_genetic11","pc_genetic12","pc_genetic13","pc_genetic14",
                                "pc_genetic15","pc_genetic16","pc_genetic17","pc_genetic18","pc_genetic19","pc_genetic20"))
Z[,cols] = scale(Z[,cols])
Z[,'age2'] = Z[,'age']^2

# Center scale X
cm = Matrix::colMeans(X, na.rm = TRUE)
csd = susieR:::compute_colSds(X)
csd[csd == 0] = 1
X = t((t(X) - cm) / csd)

A   <- crossprod(Z)
# chol decomposition for (Z'Z)^(-1)
R = chol(solve(A))
W = R %*% t(Z) %*% X

# Remove Covariates from X
X   <- as.matrix(X - Z %*% crossprod(R,W))

# Get estimated parameters
ss.dat = readRDS('height.LCORL.0.01.XtX.Xty.rds')
betas = as.vector(ss.dat$Xty)/diag(ss.dat$XtX)
rss = c(ss.dat$yty) - betas * ss.dat$Xty
se = as.vector(sqrt(rss/((ss.dat$n-1)*diag(ss.dat$XtX))))
R = as.matrix(t(ss.dat$XtX * (1/sqrt(diag(ss.dat$XtX)))) * (1/ sqrt(diag(ss.dat$XtX))))
mod_bhat.ld = susie_bhat(bhat = betas, shat = se, R = R, n = ss.dat$n, var_y = as.numeric(ss.dat$yty/(ss.dat$n-1)))
V = mod_bhat.ld$V[1:2]
sigma2 = mod_bhat.ld$sigma2

n = nrow(X)
result = vector("list", 1000)
set.seed(201910)
for(i in 1:1000){
  ## generate true effects
  b = c(rnorm(1, 0, sqrt(V[1])), rnorm(1, 0, sqrt(V[2])))
  Xb = as.vector(X[, c(1351, 1420)] %*% b)
  ## generate y
  y = Xb + rnorm(n, 0, sqrt(sigma2))
  
  ## compute Xty, yty
  Xty = as.vector(y %*% X)
  yty = sum(y^2)
  
  ## compute summary stats
  betas = as.vector(Xty/diag(ss.dat$XtX))
  rss = yty - betas * Xty
  se = as.vector(sqrt(rss/((n-1)*diag(ss.dat$XtX))))
  z = betas/se
  
  result[[i]] = susie_bhat(betas, se, R=R, n=n, var_y = as.numeric(yty/(n-1)))
}
saveRDS(result, 'height.LCORL.0.01.simulation1000.rds')
```

Load simulation results:
```{r}
result = readRDS('../data/height.LCORL.0.01.simulation1000.rds')
```

In 1000 runs, the number of CSs are 
```{r}
table(sapply(result, function(mod) length(mod$sets$cs)))
```

699 runs contain rs6824748 in the CSs, 556 runs contain rs2610989 in the CSs. 
```{r}
contain.true = sapply(result, function(mod) 1351 %in% unlist(mod$sets$cs))
sum(contain.true)
contain.true = sapply(result, function(mod) 1420 %in% unlist(mod$sets$cs))
sum(contain.true)
```










