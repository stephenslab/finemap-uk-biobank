---
title: "Blood cells Strong signal patterns"
author: "Yuxin Zou"
date: "12/1/2020"
output: 
  workflowr::wflow_html:
    code_folding: hide
---

```{r}
library(data.table)
library(flashr)
library(mixsqp)
library(udr)
```

1. Extract 1 snp per region with the strongest signal
```{r strongsignals}
regions = fread('/project2/mstephens/yuxin/ukb-bloodcells/regions.csv')
colnames(regions) = c('chr', 'start', 'end', 'length', 'maxlog10p', 'numsnps')
z.strong = c()
z.random = c()
set.seed(2020)
for (i in 1:nrow(regions)){
  dat = readRDS(paste0('/project2/mstephens/yuxin/ukb-bloodcells/zscores/bloodcells_chr',
                       regions$chr[i], '.', regions$start[i], '.', regions$end[i],'.z.rds'))
  z = dat$Z
  strong.id = which.max(apply(abs(z), 1, max))
  z.strong = rbind(z.strong, z[strong.id, ])
  
  null.id = which(apply(abs(z), 1, max) < 2)
  random_idx = sample(null.id, 1, replace = F)
  z.random = rbind(z.random, z[random_idx,])
}
```

2. PCA
```{r pca}
par(mfrow=c(1,3))
res.svd = svd(z.strong,nv=3,nu=3)
f = res.svd$v
rownames(f) = colnames(z.strong)
U.pca = mashr:::cov_from_factors(t(f), "PCA")
d = diag(res.svd$d[1:3])
U.pca = c(U.pca, list("tPCA"= f %*% d^2 %*% t(f)/nrow(z.strong)))
for(i in 1:3){
  barplot(f[,i], cex.names = 0.7,
          las = 2, main = paste0("EigenVector ", i, ' pve: ', round(res.svd$d[i]^2/sum(res.svd$d^2), 3)))
}
```

3. FLASH
```{r, message=FALSE, eval=FALSE}
f.d = flash_set_data(as.matrix(z.strong))
f = flashr::flash(f.d, greedy=TRUE, backfit = T)
saveRDS(f, 'output/BloodCells.flash.model.rds')
```

```{r flash}
f = readRDS('output/BloodCells.flash.model.rds')
nonunique_effects <- function(fl) {
    thresh <- 1/sqrt(ncol(fl$fitted_values))
    vals_above_avg <- colSums(fl$ldf$f > thresh)
    nonuniq_effects <- which(vals_above_avg > 1)
    return(nonuniq_effects)
}
nonunique_effects_id = nonunique_effects(f)
par(mfrow=c(2,3))
for(i in 1:13){
  barplot(f$ldf$f[,i], cex.names = 0.7,
          las = 2, main = paste0("Flash factor ", i, " pve: ", round(f$pve[i], 2)))
}
```

```{r ulist, eval=FALSE}
U.flash = c(mashr:::cov_from_factors(t(as.matrix(f$ldf$f)), "FLASH"),
                list("tFLASH" = t(f$fitted_values) %*% f$fitted_values / nrow(f$fitted_values)))

Ulist = c(U.flash, U.pca, list("XX" = t(as.matrix(z.strong)) %*% as.matrix(z.strong) / nrow(z.strong)))
z.random.cov = cov(z.random)
saveRDS(Ulist, 'output/BloodCells.flash.pca.ulist.rds')

traits = fread('/project2/mstephens/yuxin/ukb-bloodcells/bloodcells.pheno.txt')
Ycov = cov(traits[,3:18])
saveRDS(list(z.random.cov = z.random.cov, Y.cov = Ycov), 'output/BloodCells.cov.rds')
```

```{r ed, eval=FALSE}
library(udr)
fit.ed.S.y <- ud_fit(X = z.strong, U = Ulist, S = Ycov, control = list(update.U = "ed", maxiter=5000), verbose=FALSE)
fit.ed.S.y.cor <- ud_fit(X = z.strong, U = Ulist, S = cov2cor(Ycov), control = list(update.U = "ed", maxiter=5000), verbose=FALSE)

# fit.ed.S.z.cov <- ud_fit(X = z.strong, U = Ulist, S = z.random.cov, control = list(update.U = "ed", maxiter=5000), verbose=FALSE)
# fit.ed.S.z.cor <- ud_fit(X = z.strong, U = Ulist, S = cov2cor(z.random.cov), control = list(update.U = "ed", maxiter=5000), verbose=FALSE)

saveRDS(fit.ed.S.y, 'output/BloodCells.Ulist.Scov.ed.rds')
saveRDS(fit.ed.S.y.cor, 'output/BloodCells.Ulist.Scor.ed.rds')
```

ED weights:
```{r}
fit.ed = readRDS('output/BloodCells.Ulist.Scor.ed.rds')
barplot(fit.ed$w, las=2, cex.names = 0.7)
```


